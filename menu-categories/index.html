<!doctype html>
<html>
<head>
  <title>Goodybag - India</title>
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/bootstrap-responsive.css" rel="stylesheet" media="screen">
  <link href="css/bootstrap-editable.css" rel="stylesheet">
  <link href="select2/select2.css" rel="stylesheet" type="text/css"></link>

  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="select2/select2.js"></script>
  <script src="js/handlebars.js"></script>
  <script src="js/async.js"></script>
  <script src="js/jquery.mockjax.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap-editable.js"></script>
  <script src="js/bootbox.min.js"></script>
  <script src="js/templates.js"></script>
  <script type="text/javascript">
    (function(a){if(window.filepicker){return}var b=a.createElement("script");b.type="text/javascript";b.async=!0;b.src=("https:"===a.location.protocol?"https:":"http:")+"//api.filepicker.io/v1/filepicker.js";var c=a.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c);var d={};d._queue=[];var e="pick,pickMultiple,pickAndStore,read,write,writeUrl,export,convert,store,storeUrl,remove,stat,setKey,constructWidget,makeDropPane".split(",");var f=function(a,b){return function(){b.push([a,arguments])}};for(var g=0;g<e.length;g++){d[e[g]]=f(e[g],d._queue)}window.filepicker=d})(document);
  </script>
  <script type="text/javascript">filepicker.setKey('AfYrJ8jdRQykuY971MKeQz');</script>

  <style type="text/css">
    .product-img {
      cursor: pointer;
    }
  </style>

</head>
<body>

  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">Saruman 1.0</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
              <li class="">
                <a href="/#/businesses">Businesses</a>
              </li>
              <li class="">
                <a href="/#/logout">Logout</a>
              </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="margin-top: 100px">
    <div class="row">
      <div class="span2">
        <ul class="nav nav-tabs nav-stacked">
          <li class="main">
            <a href="/#/businesses/{{id}}">Main Info</a>
          </li>
          <li class="locations">
            <a href="/#/businesses/{{id}}/locations">Locations</a>
          </li>
          <li class="menu-categories active">
            <a href="/#/businesses/{{id}}/menu-categories">Menu Items/Categories</a>
          </li>
          <li class="menu-details">
            <a href="/#/businesses/{{id}}/menu-details">Menu Details</a>
          </li>
          <li class="social-media">
            <a href="/#/businesses/{{id}}/locations">Social Media</a>
          </li>
        </ul>
      </div>
      <div class="span10">
        <h2>Menu Item Categories</h2>
        <table class="table table-striped table-bordered" style="word-wrap: break-word;">
          <thead>
            <tr>
              <th style="width: 5%">Order</th>
              <th style="width: 30%">Name</th>
              <th style="width: 60%">Description</th>
              <th style="width: 5%">Actions</th>
            </tr>
          </thead>
          <tbody class="menu-categories-table">
            <!-- hbs: category-row -->
          </tbody>
        </table>
        <button class="add-category-button btn btn-primary"><i class="icon-plus icon-white"></i> Add Category</button>
      </div>
    </div>
    <div>
    <div class="row">
      <div class="span2"></div>
      <div class="span10">
        <h2>Menu Items</h2>
        <table class="table table-striped table-bordered" style="word-wrap: break-word;">
          <thead>
            <tr>
              <th style="width: 15%">Name</th>
              <th style="width: 35%">Description</th>
              <th style="width: 10%">Price</th>
              <th style="width: 15%">Categories</th>
              <th style="width: 10%">Tags</th>
              <th style="width: 10%">Photo</th>
              <th style="width: 5%">Actions</th>
            </tr>
          </thead>
          <tbody class="menu-items-table">
            <!-- hbs: category-row -->
          </tbody>
        </table>
        <button class="add-item-button btn btn-primary"><i class="icon-plus icon-white"></i> Add Item</button>
      </div>
    </div>
  </div>

  <script>
    Handlebars.registerHelper('money', function(text) {
      var amount = (+text) ? (+text)/100 : "";
      return amount+"";
    });

    $.getJSON = function(url, successCallback){
      $.ajax({
        type: 'GET'
      , crossDomain: true
      , xhrFields: {withCredentials: true}
      , url: url
      , success: successCallback
      });
    };

    $(function(){
      var base = 'http://localhost:3000/v1';
      var businessId = 1;
      var tags = [];
      var tagNamesToId = {};

      var productImgClickHandler = function(e){
        var
          $target = $(e.target)
        , pid = $target.data('id')
        ;
        filepicker.pick(
          { mimetypes:['image/*'] },
          function(file) {
            $target.attr('src', file.url);
            updateItem(pid, { photoUrl: file.url }, function(result){
              if (result.error) alert(result.error.message);
            });
          },
          function(error) {
            console.log(error);
          }
        )
      };

      // Get the business Id from the url query params
      if (window.location.href.indexOf('businessId')){
        businessId = window.location.href.split(/\?|\&/g);
        for (var i = businessId.length - 1; i >= 0; i--){
          if (businessId[i].indexOf('businessId=') > -1){
            businessId = parseInt(businessId[i].substring(businessId[i].lastIndexOf('=') + 1));
            break;
          }
        }
      }

      // Fix Nav
      $(function(){
        $('.nav a').each(function(i, el){
          el.href = el.href.replace("{{id}}", businessId);
        });
      });

      // $.ajax({
      //     url: base+'/session'
      //   , type: 'POST'
      //   , data: {
      //       email: 'admin@goodybag.com'
      //     , password: 'password'
      //     }
      //   , dataType: 'json'
      //   , xhrFields: {
      //       withCredentials: true
      //     }
      //   , crossDomain: true
      //   , success: function(content){
      //     }
      //   });

      $('.add-category-button').click(function(){
        bootbox.prompt("Category name?", function(value) {
          if (!value) return;
          createCategory({businessId: businessId, name: value}, function(result){
            if(result.error) {bootbox.alert('error saving category: '+value); return console.error(result.error);}
            var $html = $(Handlebars.templates['category-row']({data:[{id: result.data.id, name: value}]}));
            console.log($html);
            makeCategoryEditable($html);
            $(".menu-categories-table").append($html);
            $('.item-categories').each(function(){
              delete $(this).data('editable').input.sourceData;
            });
          });
        });
      });

      $('.add-item-button').click(function(){
        bootbox.prompt("Item name?", function(value) {
          if (!value) return;
          createItem({businessId: businessId, name: value}, function(result){
            if(result.error) {bootbox.alert('error saving item: '+value); return console.error(result.error);}
            var $html = $(Handlebars.templates['item-row']({data:[{id: result.data.id, name: value}]}));
            console.log($html);
            makeItemEditable($html);
            $html.find('.product-img').click(productImgClickHandler);
            $(".menu-items-table").append($html);
          });
        });
      });

      $.getJSON(base+'/businesses/'+businessId+'/product-categories', function(data){
        var $html = $(Handlebars.templates['category-row'](data));
        makeCategoryEditable($html);
        $(".menu-categories-table").append($html);
      });


      $.getJSON(base+'/businesses/'+businessId+'/product-tags', function(response){
        if(response.error) return console.log(response.error);

        for(index in response.data){
          tags.push(response.data[index].tag);
          tagNamesToId[response.data[index].tag] = +response.data[index].id;
        }
        $.getJSON(base+'/businesses/'+businessId+'/products', function(data){
          var $html = $(Handlebars.templates['item-row'](data));
          makeItemEditable($html);
          $(".menu-items-table").append($html);

          $('.product-img').click(productImgClickHandler);
        });
      });

      function makeCategoryEditable(context){
        $('.category-order', context).each(function(){
          $(this)
            .attr('data-original-title', 'Enter Value')
            .attr('data-type', 'text')
            .editable({
              validate: function(value){
                if(! +value){
                  return 'This must be a number greater than 0';
                }
              }
            });
        });

        $('.category-name, .category-description', context).each(function(){
          $(this)
            .attr('data-original-title', 'Enter Value')
            .attr('data-type', 'text')
            .editable({});
        });

        $('.category-order', context).on('save', function(e, params){
          var $self = $(this);
          updateCategory($self.attr('data-id'), {order: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.category-name', context).on('save', function(e, params){
          var $self = $(this);
          updateCategory($self.attr('data-id'), {name: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.category-description', context).on('save', function(e, params){
          var $self = $(this);
          if($self.attr('data-id')){
            updateCategory($self.attr('data-id'), {description: params.newValue}, function(result){
              if(result.error) return console.error(result.error);
              $self.removeClass('editable-unsaved');
            });
          }
        });

        $('.delete-category-button', context).click(function(){
          var $self = $(this);
          bootbox.confirm("Are you sure?", function(confirm) {
            if(!confirm) return;
            deleteCategory($self.attr('data-id'), function(result){
              if(result.error) return console.error(result.error);
              $self.closest('tr').remove();

              $('.item-categories').each(function(){
                delete $(this).data('editable').input.sourceData;
              });
            });
          });
        });
      }

      function updateCategory(id, data, callback){
        $.ajax({
          url: base+'/product-categories/' + id
        , type: 'PUT'
        , data: data
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      function createCategory(data, callback){
        $.ajax({
          url: base+'/product-categories'
        , type: 'POST'
        , data: data
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      function deleteCategory(id, callback){
        $.ajax({
          url: base+'/product-categories/'+id
        , type: 'DELETE'
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      $.mockjax({
          url: '/tags',
          response: function(settings) {
            var ret = [];
            $('.category-name').each(function(){
              ret.push({value: +$(this).attr('data-id'), text: $(this).data('editable').value});
            });
            this.responseText = ret;
          }
      });
      $.mockjax({
          url: '/categories',
          response: function(settings) {
            var ret = [];
            $('.category-name').each(function(){
              ret.push({value: +$(this).attr('data-id'), text: $(this).data('editable').value});
            });
            this.responseText = ret;
          }
      });

      function makeItemEditable(context){
        $('.item-name, .item-description', context).each(function(){
          $(this)
            .attr('data-original-title', 'Enter Value')
            .attr('data-type', 'text')
            .editable();
        });

        $('.item-price', context).each(function(){
          $(this)
            .attr('data-original-title', 'Enter Value')
            .attr('data-type', 'text')
            .editable({
              validate: function(value) {
                if(isNaN(value)){
                  return 'This must be a number';
                }
              }
            });
        })

        $('.item-categories, .item-tags', context).each(function(){
          var $self = $(this);
          var id = $self.attr('data-id');
          $.getJSON(base+'/products/'+id, function(response){
            if(response.error) return console.log(response.error);
            var categoryIds = [];
            var _tags = [];
            for(index in response.data.categories){
              if (response.data.categories[index] && response.data.categories[index].id) categoryIds.push(response.data.categories[index].id);
            }
            for(index in response.data.tags){
              if (response.data.tags[index] && response.data.tags[index].tag) _tags.push(response.data.tags[index].tag);
            }
            if($self.hasClass('item-categories')){
              $self
                .attr('data-original-title', 'Enter Value')
                .attr('data-type', 'checklist')
                .editable({
                  value: categoryIds
                , sourceCache: false
                , source: function(){
                    var ret = [];
                    $('.category-name').each(function(){
                      ret.push({value: +$(this).attr('data-id'), text: $(this).data('editable').value});
                    });
                    return ret;
                  }
                });
              // causes the list to refresh
              $self.on('hidden', function(e, params){
                delete $(this).data('editable').input.sourceData;
              });
            } else if ($self.hasClass('item-tags')){
              $self.text(_tags.join(', '));
              $self
                .attr('data-original-title', 'Enter Value')
                .attr('data-type', 'select2')
                .editable({
                  select2: {
                    tags: tags
                  , tokenSeparators: [","]
                  }
                });
              // causes the list to refresh
              $self.on('hidden', function(e, params){
                delete $(this).data('editable').input.sourceData;
              });
            }
          });
        });

        $('.item-name', context).on('save', function(e, params){
          var $self = $(this);
          updateItem($self.attr('data-id'), {name: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.item-description', context).on('save', function(e, params){
          var $self = $(this);
          updateItem($self.attr('data-id'), {description: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.item-price', context).on('save', function(e, params){
          var $self = $(this);
          var price = Math.round((+params.newValue)*100);
          updateItem($self.attr('data-id'), {price: price}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.item-categories', context).on('save', function(e, params){
          var $self = $(this);

          // for some reason it makes the ids strings so need to convert back to int
          var categories = [];
          for (val in params.newValue)
            categories.push(+params.newValue[val]);
          updateItem($self.attr('data-id'), {categories: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        });

        $('.item-tags', context).on('save', function(e, params){
          var $self = $(this);
          var productId = $self.attr('data-id');
          var _tags = [];
          var dne = [];
          for(index in params.newValue){
            var tag = params.newValue[index];
            var id = tagNamesToId[tag];
            if(id) _tags.push(id);
            if(!id) dne.push(tag);
          }
          async.forEach(
            dne
          , function(tag, callback){
              createProductTag({tag: tag}, function(response){
                if(response.error) return callback(response.error);
                tags.push(tag);
                tagNamesToId[tag] = response.data.id;
                _tags.push(tagNamesToId[tag]);
                callback();
              });
            }
          , function(err){
              if(err) return console.error(err);
              updateItem($self.attr('data-id'), {tags: _tags}, function(result){
                if(result.error) return console.error(result.error);
                $self.removeClass('editable-unsaved');
              });
            }
          );
        });

        $('.delete-item-button', context).click(function(){
          var $self = $(this);
          bootbox.confirm("Are you sure?", function(confirm) {
            if(!confirm) return;
            deleteItem($self.attr('data-id'), function(result){
              if(result.error) return console.error(result.error);
              $self.closest('tr').remove();
            });
          });
        });
      }

      function updateItem(id, data, callback){
        $.ajax({
          url: base+'/products/' + id
        , type: 'PUT'
        , data: data
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      function createItem(data, callback){
        $.ajax({
          url: base+'/products'
        , type: 'POST'
        , data: data
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      function deleteItem(id, callback){
        $.ajax({
          url: base+'/products/'+id
        , type: 'DELETE'
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }

      function createProductTag(data, callback){
        $.ajax({
          url: base+'/businesses/'+businessId+'/product-tags'
        , type: 'POST'
        , data: data
        , dataType: 'json'
        , xhrFields: {
            withCredentials: true
          }
        , crossDomain: true
        , success: function(result){
            callback(result);
          }
        });
      }
    });
  </script>
</body>
</html>
