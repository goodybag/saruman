<!doctype html>
<html>
<head>
  <title>Goodybag - India</title>
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/bootstrap-editable.css" rel="stylesheet">

  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap-editable.js"></script>
  <script src="js/handlebars.js"></script>
  <script src="js/templates.js"></script>
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">Saruman 1.0</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            {{#if loggedIn}}
              <li class="">
                <a href="/#/businesses">Businesses</a>
              </li>
              <li class="">
                <a href="/#/logout">Logout</a>
              </li>
            {{else}}
            {{/if}}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="margin-top: 100px">
    <div class="row">
      <div class="span3">
        <ul class="nav nav-tabs nav-stacked">
          <li class="main">
            <a href="/#/businesses/{{id}}">Main Info</a>
          </li>
          <li class="locations">
            <a href="/#/businesses/{{id}}/locations">Locations</a>
          </li>
          <li class="menu-categories active">
            <a href="/#/businesses/{{id}}/menu-categories">Menu Items/Categories</a>
          </li>
          <li class="menu-details">
            <a href="/#/businesses/{{id}}/menu-details">Menu Details</a>
          </li>
          <li class="social-media">
            <a href="/#/businesses/{{id}}/locations">Social Media</a>
          </li>
        </ul>
      </div>
      <div class="span9">
        <h2>Menu Item Categories</h2>
        <table class="table table-striped table-bordered" style="word-wrap: break-word;">
          <thead>
            <tr>
              <th style="width: 25%">Name</th>
              <th style="width: 65%">Description</th>
              <th style="width: 10%">Actions</th>
            </tr>
          </thead>
          <tbody class="menu-categories-table">
            <!-- hbs: category-row -->
          </tbody>
        </table>
        <button class="add-category-button btn btn-primary"><i class="icon-plus icon-white"></i> Add Category</button>
      </div>
    </div>
  </div>

  <script>
    var base = 'http://localhost:3000/v1';
    var businessId = 1;

    // Get the business Id from the url query params
    if (window.location.href.indexOf('businessId')){
      businessId = window.location.href.split(/\?|\&/g);
      for (var i = businessId.length - 1; i >= 0; i--){
        if (businessId[i].indexOf('businessId=') > -1){
          businessId = parseInt(businessId[i].substring(businessId[i].lastIndexOf('=') + 1));
          break;
        }
      }
    }

    // Fix Nav
    $(function(){
      $('.nav a').each(function(i, el){
        el.href = el.href.replace("{{id}}", businessId);
      });
    });

    $.ajax({
        url: base+'/session'
      , type: 'POST'
      , data: {
          email: 'admin@goodybag.com'
        , password: 'password'
        }
      , dataType: 'json'
      , xhrFields: {
          withCredentials: true
        }
      , crossDomain: true
      , success: function(content){
          console.log(content);
        }
      });

    $('.add-category-button').click(function(){
      var $html = $(Handlebars.templates['category-row']({data:[{name: "", description: ""}]}));
      makeEditable($html);
      $(".menu-categories-table").append($html);
    });

    $.getJSON(base+'/businesses/'+businessId+'/productCategories', function(data){
      var $html = $(Handlebars.templates['category-row'](data));
      makeEditable($html);
      $(".menu-categories-table").append($html);
    });
  </script>

  <script>
    function makeEditable(context){
      $('.category-name, .category-description', context).each(function(){
        $(this)
          .attr('data-original-title', 'Enter Description')
          .attr('data-type', 'text')
          .editable();
      });

      $('.category-name', context).on('save', function(e, params){
        var $self = $(this);
        if($self.attr('data-id')){
          updateCategory($self.attr('data-id'), {name: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        } else {
          $description = $('.category-description', $self.closest('tr'))
          var description = $description.data('editable').value;

          createCategory({businessId: businessId, name: params.newValue, description: description}, function(result){
            if(result.error) return console.error(result.error);

            $self.attr('data-id', result.data.id);
            $description.attr('data-id', result.data.id);

            $self.removeClass('editable-unsaved');
            $description.removeClass('editable-unsaved');
          });
        }
      });

      $('.category-description', context).on('save', function(e, params){
        var $self = $(this);
        if($self.attr('data-id')){
          updateCategory($self.attr('data-id'), {description: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        }
      });

      $('.category-description', context).on('save', function(e, params){
        var $self = $(this);
        if($self.attr('data-id')){
          updateCategory($self.attr('data-id'), {description: params.newValue}, function(result){
            if(result.error) return console.error(result.error);
            $self.removeClass('editable-unsaved');
          });
        }
      });

      $('.delete-category-button', context).click(function(){
        var $self = $(this);
        deleteCategory($self.attr('data-id'), function(result){
          if(result.error) return console.error(result.error);
          $self.closest('tr').remove();
        });
      })
    }

    function updateCategory(id, data, callback){
      $.ajax({
        url: base+'/productCategories/' + id
      , type: 'PATCH'
      , data: data
      , dataType: 'json'
      , xhrFields: {
          withCredentials: true
        }
      , crossDomain: true
      , success: function(result){
          callback(result);
        }
      });
    }

    function createCategory(data, callback){
      $.ajax({
        url: base+'/productCategories'
      , type: 'POST'
      , data: data
      , dataType: 'json'
      , xhrFields: {
          withCredentials: true
        }
      , crossDomain: true
      , success: function(result){
          callback(result);
        }
      });
    }

    function deleteCategory(id, callback){
      $.ajax({
        url: base+'/productCategories/'+id
      , type: 'DELETE'
      , dataType: 'json'
      , xhrFields: {
          withCredentials: true
        }
      , crossDomain: true
      , success: function(result){
          callback(result);
        }
      });
    }
  </script>
</body>
</html>